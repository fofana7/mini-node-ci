name: ğŸ§ª CI Pipeline

# DÃ©clencheurs du workflow
on:
  push:
    branches:
      - "main"
      - "develop"
      - "feature/**"
  pull_request:
    branches:
      - "main"
      - "develop"

jobs:
  build-test-analyze:
    name: Build, Test & Analyze
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© Ã‰tape 1 : RÃ©cupÃ©ration du code source
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # NÃ©cessaire pour SonarCloud (analyse complÃ¨te de lâ€™historique)

      # âš™ï¸ Ã‰tape 2 : Configuration de Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"     # AccÃ©lÃ¨re les builds grÃ¢ce au cache npm

      # ğŸ“¦ Ã‰tape 3 : Installation des dÃ©pendances
      - name: Install dependencies
        run: npm ci        # Utilise le package-lock.json pour une installation dÃ©terministe

      # ğŸ§¹ Ã‰tape 4 : VÃ©rification du code avec ESLint
      - name: Run ESLint
        run: npm run lint

      # ğŸ§ª Ã‰tape 5 : Lancement des tests unitaires avec couverture
      - name: Run tests with coverage
        run: npm test -- --coverage
        env:
          NODE_OPTIONS: --experimental-vm-modules  # Permet d'utiliser ES modules (import/export)

      # ğŸ” Ã‰tape 6 : Analyse du code avec SonarCloud
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .  # Racine du projet
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Permet Ã  Sonar dâ€™accÃ©der aux mÃ©tadonnÃ©es du dÃ©pÃ´t
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}    # Ton token dâ€™analyse SonarCloud
